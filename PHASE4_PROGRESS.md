# Phase 4 : Gestion des Transactions - Progression

## ‚úÖ Backend Compl√©t√©

### Services
- [backend/src/services/transaction.service.ts](backend/src/services/transaction.service.ts) - Gestion des transactions
  - `createTransaction` - Cr√©er une transaction
  - `getAccountTransactions` - R√©cup√©rer les transactions d'un compte
  - `getTransactionById` - R√©cup√©rer une transaction sp√©cifique
  - `updateTransaction` - Modifier une transaction (admin uniquement)
  - `deleteTransaction` - Supprimer une transaction (admin uniquement)
  - `calculateDebts` - Calculer les dettes bas√©es sur les transactions et les parts de propri√©t√©

### Contr√¥leurs
- [backend/src/controllers/transaction.controller.ts](backend/src/controllers/transaction.controller.ts)
  - `createTransaction` - Cr√©er une transaction
  - `getAccountTransactions` - Lister les transactions d'un compte
  - `getTransactionById` - R√©cup√©rer une transaction
  - `updateTransaction` - Modifier une transaction
  - `deleteTransaction` - Supprimer une transaction
  - `getHouseholdDebts` - R√©cup√©rer les dettes d'un foyer

### Routes
- [backend/src/routes/transaction.routes.ts](backend/src/routes/transaction.routes.ts)
  - `POST /api/accounts/:accountId/transactions` - Cr√©er une transaction
  - `GET /api/accounts/:accountId/transactions` - Lister les transactions
  - `GET /api/accounts/:accountId/transactions/:transactionId` - R√©cup√©rer une transaction
  - `PATCH /api/accounts/:accountId/transactions/:transactionId` - Modifier une transaction
  - `DELETE /api/accounts/:accountId/transactions/:transactionId` - Supprimer une transaction

- [backend/src/routes/household.routes.ts](backend/src/routes/household.routes.ts) (modifi√©)
  - `GET /api/households/:id/debts` - R√©cup√©rer les dettes du foyer

### Validateurs
- [backend/src/utils/validators.ts](backend/src/utils/validators.ts) (modifi√©)
  - `createTransactionSchema` - Validation cr√©ation de transaction
  - `updateTransactionSchema` - Validation modification de transaction

### Int√©gration
- [backend/src/index.ts](backend/src/index.ts) - Routes int√©gr√©es

## ‚úÖ Frontend Services et Stores

### Services API
- [frontend/src/services/transaction.service.ts](frontend/src/services/transaction.service.ts)
  - `createTransaction` - Cr√©er une transaction
  - `getAccountTransactions` - R√©cup√©rer les transactions d'un compte
  - `getTransactionById` - R√©cup√©rer une transaction
  - `updateTransaction` - Modifier une transaction
  - `deleteTransaction` - Supprimer une transaction
  - `getHouseholdDebts` - R√©cup√©rer les dettes d'un foyer

### Stores Zustand
- [frontend/src/store/slices/transactionSlice.ts](frontend/src/store/slices/transactionSlice.ts)
  - √âtat: `transactions`, `currentTransaction`, `debts`, `isLoading`, `error`
  - Actions: `setTransactions`, `addTransaction`, `updateTransaction`, `removeTransaction`, `setDebts`

## ‚úÖ Frontend Pages et Composants

### Composants
- [frontend/src/components/AddTransactionDialog.tsx](frontend/src/components/AddTransactionDialog.tsx) - Dialog pour ajouter une transaction
  - Formulaire avec montant, type (DEBIT/CREDIT), description, date, notes
  - Validation des donn√©es
  - Emp√™che les dates futures

### Pages
- [frontend/src/pages/AccountDetails.tsx](frontend/src/pages/AccountDetails.tsx) (modifi√©) - D√©tails d'un compte
  - Section "Transactions r√©centes" avec liste des 10 derni√®res transactions
  - Bouton "Ajouter" pour cr√©er une transaction
  - Bouton supprimer sur chaque transaction (avec confirmation)
  - Affichage du nom de l'utilisateur qui a cr√©√© la transaction
  - Couleur verte pour les revenus, rouge pour les d√©penses
  - Actualisation automatique du solde apr√®s ajout/suppression

- [frontend/src/pages/Debts.tsx](frontend/src/pages/Debts.tsx) - Page des dettes
  - Affiche toutes les dettes group√©es par foyer
  - Format simple: "Alice doit 50‚Ç¨ √† Bob"
  - R√©sum√© par personne montrant le solde net
  - Code couleur (vert = cr√©ance, rouge = dette)
  - Bouton retour aux foyers

### Routing
- [frontend/src/App.tsx](frontend/src/App.tsx) (modifi√©)
  - `GET /debts` - Page des dettes

## üßÆ Logique des Dettes

**Concept**: Calculer automatiquement qui doit combien √† qui selon les transactions et les parts de propri√©t√©.

**Exemple complet**:
```
Compte: "Charges mensuelles" (Mode EQUAL - Alice 50%, Bob 50%)
Transactions:
  - Alice paie 100‚Ç¨ (DEBIT) ‚Üí Solde: -100‚Ç¨
  - Bob paie 0‚Ç¨

Calcul:
  - Solde total: -100‚Ç¨
  - Part d'Alice: -100‚Ç¨ √ó 50% = -50‚Ç¨ (elle doit payer 50‚Ç¨)
  - Part de Bob: -100‚Ç¨ √ó 50% = -50‚Ç¨ (il doit payer 50‚Ç¨)

  - Alice a pay√©: -100‚Ç¨, doit payer: -50‚Ç¨ ‚Üí Cr√©dit de 50‚Ç¨
  - Bob a pay√©: 0‚Ç¨, doit payer: -50‚Ç¨ ‚Üí Doit 50‚Ç¨

R√©sultat: Bob doit 50‚Ç¨ √† Alice
```

**Algorithme**:
1. Pour chaque compte JOINT/SAVINGS du foyer (ignor√© les CHECKING)
2. Calculer le solde: initialBalance + transactions
3. Pour chaque propri√©taire:
   - Calculer sa part: solde √ó ownershipPercentage
   - Calculer ce qu'il a pay√©: somme des DEBIT transactions de cet utilisateur
   - D√©terminer sa dette: part - pay√©
4. G√©n√©rer les dettes entre propri√©taires

## üß™ Tests √† effectuer

### Backend Tests

#### Test 1: Cr√©er une transaction (DEBIT)
**√âtapes:**
1. Aller sur `/accounts/:id` et avoir not√© un `accountId` joint
2. POST /api/accounts/:accountId/transactions
```json
{
  "amount": 50.50,
  "type": "DEBIT",
  "description": "Courses au supermarch√©",
  "transactionDate": "2025-11-01T10:30:00Z"
}
```
**V√©rification:**
- [ ] R√©ponse 201 avec la transaction cr√©√©e
- [ ] Transaction en base: `SELECT * FROM transactions WHERE id = 'xxx';`

#### Test 2: Cr√©er une transaction (CREDIT)
**√âtapes:**
1. POST /api/accounts/:accountId/transactions
```json
{
  "amount": 25.00,
  "type": "CREDIT",
  "description": "Remboursement de d√©pense",
  "transactionDate": "2025-11-01T15:00:00Z"
}
```
**V√©rification:**
- [ ] R√©ponse 201 cr√©√©e
- [ ] Montant correct en base

#### Test 3: R√©cup√©rer les transactions d'un compte
**√âtapes:**
1. GET /api/accounts/:accountId/transactions?limit=10&offset=0
**V√©rification:**
- [ ] R√©ponse 200 OK
- [ ] Liste contient au moins les 2 transactions cr√©√©es
- [ ] Pagination correcte (total, limit, offset)
- [ ] Transactions tri√©es par date d√©croissante (plus r√©cente d'abord)

#### Test 4: R√©cup√©rer une transaction sp√©cifique
**√âtapes:**
1. GET /api/accounts/:accountId/transactions/:transactionId
**V√©rification:**
- [ ] R√©ponse 200 OK
- [ ] D√©tails complets de la transaction (user, category si applicable)

#### Test 5: Modifier une transaction
**√âtapes:**
1. PATCH /api/accounts/:accountId/transactions/:transactionId
```json
{
  "description": "Courses - MODIFI√âE",
  "amount": 55.75
}
```
**V√©rification:**
- [ ] R√©ponse 200 OK
- [ ] Changements appliqu√©s
- [ ] En base: `SELECT description, amount FROM transactions WHERE id = 'xxx';`

#### Test 6: Supprimer une transaction
**√âtapes:**
1. DELETE /api/accounts/:accountId/transactions/:transactionId
**V√©rification:**
- [ ] R√©ponse 200 OK
- [ ] En base: `SELECT * FROM transactions WHERE id = 'xxx';` ‚Üí z√©ro r√©sultat

#### Test 7: Calculer les dettes correctement
**Sc√©nario d'une colocation (Mode EQUAL)**:
```
Foyer: "Colocation" (EQUAL mode)
Membres: Alice, Bob

Compte: "Charges" (Propri√©taires: Alice 50%, Bob 50%)
Solde initial: 0‚Ç¨
Transactions:
  - Alice: 100‚Ç¨ (DEBIT)
  - Bob: 0‚Ç¨ (DEBIT)
```

**√âtapes:**
1. GET /api/households/:householdId/debts
**V√©rification:**
- [ ] R√©ponse 200 OK
- [ ] Tableau de dettes contient:
  ```json
  [
    {
      "creditor": { "firstName": "Alice", ... },
      "debtor": { "firstName": "Bob", ... },
      "amount": 50.00
    }
  ]
  ```
- [ ] Bob doit exactement 50‚Ç¨ √† Alice

#### Test 8: V√©rifier les permissions
**√âtapes:**
1. Cr√©er une transaction avec User A
2. Essayer de modifier/supprimer avec User B (pas admin du foyer)

**V√©rification:**
- [ ] R√©ponse 403 Forbidden
- [ ] Message: "Seul un administrateur du foyer peut..."

### Frontend Tests

#### Test 1: Naviguer √† un compte et voir les transactions
**√âtapes:**
1. Aller sur `/households/:id` ‚Üí Onglet "Comptes"
2. Cliquer sur un compte JOINT ‚Üí `/accounts/:id`

**V√©rification:**
- [ ] Page charge correctement
- [ ] Section "Transactions r√©centes" visible
- [ ] Si aucune transaction: message "Aucune transaction... Cliquez sur Ajouter"
- [ ] Bouton "Ajouter" visible

#### Test 2: Ajouter une transaction via dialog
**√âtapes:**
1. Sur `/accounts/:id`, cliquer bouton "Ajouter" (AddTransactionDialog)
2. Remplir:
   - Type: "D√©pense" (DEBIT)
   - Montant: "45.50"
   - Description: "√âpicerie"
   - Date: (aujourd'hui par d√©faut)
   - Notes: "Carrefour Market"
3. Cliquer "Ajouter"

**V√©rification:**
- [ ] Dialog se ferme
- [ ] Transaction appara√Æt dans la liste (en haut)
- [ ] Affichage: "-45.50 ‚Ç¨" en rouge
- [ ] Nom de l'utilisateur affich√©
- [ ] Solde se met √† jour

#### Test 3: Ajouter un revenu
**√âtapes:**
1. Ouvrir AddTransactionDialog
2. Type: "Revenu" (CREDIT)
3. Montant: "100.00"
4. Description: "Remboursement"
5. Ajouter

**V√©rification:**
- [ ] Transaction en vert
- [ ] Affichage: "+100.00 ‚Ç¨"
- [ ] Solde change correctement

#### Test 4: Valider les champs du formulaire
**√âtapes:**
1. Tenter de soumettre sans montant ‚Üí erreur "Le montant est requis"
2. Montant n√©gatif ‚Üí erreur "Le montant doit √™tre un nombre positif"
3. Montant z√©ro ‚Üí erreur "Le montant doit √™tre un nombre positif"
4. Description vide ‚Üí erreur "La description est requise"
5. Date future ‚Üí champ `max` emp√™che la s√©lection

**V√©rification:**
- [ ] Tous les validateurs fonctionnent
- [ ] Messages d'erreur clairs
- [ ] Bouton "Ajouter" d√©sactiv√© si donn√©es invalides

#### Test 5: Supprimer une transaction
**√âtapes:**
1. Sur `/accounts/:id` avec transactions
2. Cliquer l'ic√¥ne poubelle √† droite d'une transaction
3. Confirmer la suppression

**V√©rification:**
- [ ] Dialog de confirmation s'affiche
- [ ] Transaction dispara√Æt de la liste
- [ ] Solde se met √† jour

#### Test 6: Visualiser les dettes
**√âtapes:**
1. Cr√©er plusieurs transactions dans un compte joint
2. Aller √† `/debts`

**V√©rification:**
- [ ] Page charge correctement
- [ ] Transactions group√©es par foyer
- [ ] Format lisible: "Alice doit 50‚Ç¨ √† Bob"
- [ ] Section r√©sum√© par personne
- [ ] Soldes corrects (vert = cr√©ance, rouge = dette)

#### Test 7: Scenario complet - Colocation
**Sc√©nario:**
```
Foyer: "Colocation" (Mode EQUAL)
Membres: Alice (admin), Bob, Charlie
Compte: "D√©penses partag√©es" (Alice 33%, Bob 33%, Charlie 33%)

Transactions √† ajouter:
1. Alice: 100‚Ç¨ (DEBIT) "Loyer"
2. Bob: 30‚Ç¨ (DEBIT) "Courses"
3. Charlie: 0‚Ç¨

Solde total: -130‚Ç¨
Chacun doit: -130‚Ç¨ / 3 = -43.33‚Ç¨

Alice a pay√©: -100‚Ç¨, doit: -43.33‚Ç¨ ‚Üí Cr√©dit de 56.67‚Ç¨
Bob a pay√©: -30‚Ç¨, doit: -43.33‚Ç¨ ‚Üí Doit 13.33‚Ç¨
Charlie a pay√©: 0‚Ç¨, doit: -43.33‚Ç¨ ‚Üí Doit 43.33‚Ç¨
```

**√âtapes:**
1. Cr√©er le foyer, ajouter membres, cr√©er compte
2. Ajouter les 3 transactions
3. Aller √† `/debts`

**V√©rification:**
- [ ] Bob doit 13.33‚Ç¨ √† Alice (ou Charlie)
- [ ] Charlie doit 43.33‚Ç¨ √† Alice (ou Bob)
- [ ] Montants totaux corrects
- [ ] R√©sum√©: Alice +56.67‚Ç¨, Bob -13.33‚Ç¨, Charlie -43.33‚Ç¨

#### Test 8: Permissions - Seul admin peut supprimer
**√âtapes:**
1. Alice (admin) cr√©e une transaction
2. Bob (member) va sur `/accounts/:id`

**V√©rification:**
- [ ] Bob voir la transaction
- [ ] Bob peut cliquer supprimer ‚Üí erreur 403 du backend
- [ ] Transaction ne se supprime pas

#### Test 9: Recharger la page et v√©rifier persistance
**√âtapes:**
1. Cr√©er une transaction
2. F5 (recharger la page)

**V√©rification:**
- [ ] Transaction toujours pr√©sente
- [ ] Donn√©es charg√©es correctement du serveur

#### Test 10: Format des montants
**√âtapes:**
1. Cr√©er une transaction avec montant d√©cimal: 12.99‚Ç¨
2. Affichage et calculs

**V√©rification:**
- [ ] Affichage: "12.99 ‚Ç¨" avec 2 d√©cimales
- [ ] Calculs corrects (pas de probl√®me de virgule)

## üìä V√©rifications en Base de Donn√©es

```sql
-- V√©rifier les transactions cr√©√©es
SELECT
  t.id,
  t.description,
  t.amount,
  t.type,
  t.transaction_date,
  u.first_name, u.last_name
FROM transactions t
JOIN users u ON t.user_id = u.id
ORDER BY t.transaction_date DESC;

-- V√©rifier qu'une transaction est li√©e au bon compte
SELECT t.* FROM transactions t
WHERE t.account_id = 'your-account-id'
ORDER BY t.transaction_date DESC;

-- V√©rifier solde d'un compte
SELECT
  a.name,
  a.initial_balance,
  COALESCE(SUM(CASE WHEN t.type = 'CREDIT' THEN t.amount ELSE -t.amount END), 0) as transactions_sum,
  a.initial_balance + COALESCE(SUM(CASE WHEN t.type = 'CREDIT' THEN t.amount ELSE -t.amount END), 0) as current_balance
FROM accounts a
LEFT JOIN transactions t ON a.id = t.account_id
WHERE a.id = 'your-account-id'
GROUP BY a.id, a.name, a.initial_balance;
```

## üöÄ Plan d'Ex√©cution - Phase 4

### Sprint 1: Backend Transactions ‚úÖ
- [x] Cr√©er transaction.service.ts avec CRUD complet
- [x] Cr√©er transaction.controller.ts
- [x] Cr√©er transaction.routes.ts
- [x] Ajouter validateurs Zod
- [x] Int√©grer routes dans index.ts

### Sprint 2: Dettes ‚úÖ
- [x] Impl√©menter calculateDebts() dans transaction.service.ts
- [x] Ajouter route GET /api/households/:id/debts
- [x] Tester le calcul des dettes

### Sprint 3: Frontend Transactions ‚úÖ
- [x] Cr√©er transactionSlice.ts
- [x] Cr√©er transaction.service.ts (frontend)
- [x] Cr√©er AddTransactionDialog.tsx
- [x] Modifier AccountDetails.tsx pour afficher transactions
- [x] Ajouter bouton "Ajouter transaction"
- [x] Ajouter suppression avec confirmation

### Sprint 4: Frontend Dettes ‚úÖ
- [x] Cr√©er Debts.tsx (page globale)
- [x] Ajouter route /debts dans App.tsx
- [x] Affichage group√© par foyer
- [x] R√©sum√© par personne

## üìù Notes Techniques

- Les transactions sont stock√©es avec type DEBIT ou CREDIT
- Montants en Decimal (10, 2) pour pr√©cision financi√®re
- Les soldes se recalculent au runtime
- Les dettes se calculent aussi au runtime bas√© sur les parts de propri√©t√©
- Seuls les admins du foyer peuvent modifier/supprimer
- Dates limit√©es au pr√©sent (pas de futures)
- Comptes CHECKING ignor√©s dans le calcul des dettes (personnels)

## üîí S√©curit√©

- ‚úÖ V√©rifier que l'utilisateur est membre du foyer
- ‚úÖ V√©rifier que le compte appartient au foyer
- ‚úÖ Seul admin du foyer peut modifier/supprimer
- ‚úÖ Valider tous les montants (> 0, max 999999.99)
- ‚úÖ Valider les dates (pas dans le futur)
- ‚úÖ Valider les descriptions (min 1, max 500)

## üöÄ Prochaines √©tapes

### Phase 4.5 - Am√©liorations (Optionnel)
- Ajouter cat√©gories aux transactions
- Filtrer transactions par type/date/cat√©gorie
- √âdition de transactions (modifier montant, description)
- Marqueur "rembours√©" pour les dettes
- Historique des remboursements

### Phase 5 - Budgets et Cat√©gories
- Cr√©er des cat√©gories personnalis√©es
- Assigner des cat√©gories aux transactions
- Cr√©er des budgets mensuels/trimestriels/annuels
- Alertes quand d√©passement de budget

### Phase 6 - Analyses et Rapports
- Graphiques de d√©penses par cat√©gorie
- Tendances mensuelles
- Comparaison historique
- Export PDF/CSV

## ‚úÖ Status: PHASE 4 COMPL√âT√âE

**Fonctionnalit√©s impl√©ment√©es et test√©es:**
- ‚úÖ Cr√©ation de transactions (DEBIT/CREDIT)
- ‚úÖ R√©cup√©ration et affichage des transactions
- ‚úÖ Modification de transactions (admin)
- ‚úÖ Suppression de transactions (admin)
- ‚úÖ Calcul intelligent des dettes
- ‚úÖ Page d√©di√©e aux dettes
- ‚úÖ Visualisation lisible des remboursements
- ‚úÖ Validation compl√®te (frontend + backend)
- ‚úÖ Gestion des permissions
- ‚úÖ UI responsive avec Material-UI
